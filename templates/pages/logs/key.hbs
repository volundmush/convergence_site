<!-- {"title": "Convergence Mush Log Page", "slug": "logs/:key"} -->

<div class="log">
	<div class="banner">
		<h2 class="title"></h2>
	</div>
	<div class="body">
		<div class="profile">
			<table class="finger">
			</table>
		</div>
		<div class="data">
			<div class="summary">
			</div>
			<div class="participants">
				<h3>Participants</h3>
				<ul id="participantsList"></ul>
			</div>
			<div class="poses">
				<div style="display: flex; justify-content: space-between; align-items: center;">
					<h3>Poses</h3>
				<label style="display: flex; align-items: center; gap: 0.5rem;">
					<input type="checkbox" id="showOOC" style="cursor: pointer;">
					<span>Show OOC Posts</span>
				</label>
				<label style="display: flex; align-items: center; gap: 0.5rem;">
					<input type="checkbox" id="showMeter" style="cursor: pointer;">
					<span>Show Meter Posts</span>
				</label>
				</div>
				<div id="posesList"></div>
			</div>
		</div>
	</div>
</div>

<script>
	function colorizeText(str) {
		const colorMap = {
			'x': '#000000', 'X': 'background-color: #000000',
			'r': '#ff0000', 'R': 'background-color: #ff0000',
			'g': '#00ff00', 'G': 'background-color: #00ff00',
			'y': '#ffff00', 'Y': 'background-color: #ffff00',
			'b': '#0000ff', 'B': 'background-color: #0000ff',
			'm': '#ff00ff', 'M': 'background-color: #ff00ff',
			'c': '#00ffff', 'C': 'background-color: #00ffff',
			'w': '#ffffff', 'W': 'background-color: #ffffff'
		}

		const styleMap = {
			'f': 'text-decoration: blink;',
			'i': 'filter: invert(1);',
			'h': 'font-weight: bold;',
			'u': 'text-decoration: underline;'
		}

		let result = ''
		let spanDepth = 0
		let i = 0

		while(i < str.length) {
			if(str[i] === '%' && i + 2 < str.length) {
				const code = str[i + 1]
				const letter = str[i + 2]

				if((code === 'c' || code === 'C') && letter === 'n') {
					while(spanDepth > 0) {
						result += '</span>'
						spanDepth--
					}
					i += 3
					continue
				}
				else if((code === 'c' || code === 'C') && letter.match(/[a-zA-Z]/)) {
					let styles = []
					if(colorMap[letter]) {
						if(letter === letter.toUpperCase() && letter !== letter.toLowerCase()) {
							styles.push(colorMap[letter])
						} else {
							styles.push(`color: ${colorMap[letter]}`)
						}
					}
					if(styleMap[letter]) {
						styles.push(styleMap[letter])
					}
					result += `<span style="${styles.join('; ')}">`
					spanDepth++
					i += 3
					continue
				}
			}

			result += str[i]
			i++
		}

		while(spanDepth > 0) {
			result += '</span>'
			spanDepth--
		}

		return result
	}

	document.addEventListener("DOMContentLoaded", async () => {
	window.optionalANSI = function(str) {
		str = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
		return str
	}

	const res = await fetch(`/api/logs/get/${encodeURIComponent("{{ sceneKey }}")}`)
	const data = await res.json()

	if(data.error) {
		document.querySelector(".log").innerHTML = `<p>Log not found</p>`
		return
	}

	const log = data.scene
	const poses = data.poses || []
	window.log = log

	const oldTitle = document.querySelector("title").innerText
	document.querySelector("title").innerText = `${log.scene_title} — ${oldTitle}`

	document.querySelector(".log .banner .title").innerHTML = optionalANSI(log.scene_title)

	// Add log details to profile
	const details = {
		"ID": log.scene_id,
		"Status": log.scene_status,
		"Date": log.scene_date_started || log.scene_date_scheduled || "-",
		"Pitch": log.scene_pitch || "-"
	}

	for(const [key, value] of Object.entries(details)) {
		const entry = document.createElement("tr")
		const entryKey = document.createElement("td")
		entryKey.classList.add("key")
		entryKey.innerText = key
		const entryValue = document.createElement("td")
		entryValue.innerHTML = optionalANSI(String(value))
		entryValue.classList.add("value")
		entry.appendChild(entryKey)
		entry.appendChild(entryValue)
		document.querySelector(".log .body .profile .finger").appendChild(entry)
	}

	// Get unique participants from poses
	const uniqueParticipants = {}
	for(const pose of poses) {
		if(pose.entity_objid) {
			uniqueParticipants[pose.entity_objid] = {
				entity_name: pose.entity_name,
				entity_objid: pose.entity_objid
			}
		}
	}

	// Add participants
	const participantsList = document.getElementById("participantsList")
	if(Object.keys(uniqueParticipants).length) {
		for(const [objid, actor] of Object.entries(uniqueParticipants)) {
			const li = document.createElement("li")
			const link = document.createElement("a")
			const dbref = actor.entity_objid.split(':')[0].substring(1)
			link.href = `/characters/${dbref}/`
			link.textContent = actor.entity_name
			li.appendChild(link)
			participantsList.appendChild(li)
		}
	} else {
		participantsList.innerHTML = "<li>No participants recorded</li>"
	}

	// Add poses
	const posesList = document.getElementById("posesList")
	if(poses.length) {
		for(const pose of poses) {
			const poseDiv = document.createElement("expandable-item")
			const actorName = pose.entity_name || "Unknown"
			const poseDate = new Date(pose.pose_date).toLocaleString()
			const channelLabel = pose.channel_category === 1 ? ` [OOC]` : ""
			const summary = `${actorName} in ${pose.channel_name}${channelLabel} at ${poseDate}`
			const classes = []
			if(pose.channel_category === 1) classes.push("pose-ooc")
			else classes.push("pose-ic")
			if(pose.channel_name === "Meter" || pose.channel_name === "Challenge") classes.push("pose-meter")
			poseDiv.setAttribute("class", classes.join(" "))
			poseDiv.setAttribute("name", pose.actrole_name || "Pose")
			poseDiv.setAttribute("summary", summary)
			poseDiv.setAttribute("expanded", "false")

			// Split pose text on line breaks and %r, then replace %t with tabs
			const poseText = pose.pose_text || ""
			const lines = poseText.split(/\r\n|\r|\n|%r/)
			for(const line of lines) {
				if(line.trim()) {
					const poseBody = document.createElement("p")
					poseBody.classList.add("pose-paragraph")
					let processedLine = line.replace(/%t/g, "\t")
					processedLine = colorizeText(processedLine)
					poseBody.innerHTML = processedLine
					poseDiv.appendChild(poseBody)
				}
			}
			posesList.appendChild(poseDiv)
		}
	} else {
		posesList.innerHTML = "<p>No poses recorded</p>"
	}

	// Toggle OOC visibility
	const showOOCCheckbox = document.getElementById("showOOC")
	showOOCCheckbox.addEventListener("change", () => {
		posesList.classList.toggle("hide-ooc", !showOOCCheckbox.checked)
	})
	// Start with OOC hidden by default
	posesList.classList.add("hide-ooc")

	// Toggle Meter visibility
	const showMeterCheckbox = document.getElementById("showMeter")
	showMeterCheckbox.addEventListener("change", () => {
		posesList.classList.toggle("hide-meter", !showMeterCheckbox.checked)
	})
	// Start with Meter hidden by default
	posesList.classList.add("hide-meter")

	// Expandable web component
	class ExpandableItem extends HTMLElement {
		constructor() {
			super()
			this.attachShadow({ mode: "open" })
		}

		connectedCallback() {
			const name = this.getAttribute("name") || "Item"
			const summary = this.getAttribute("summary") || ""
			const initiallyExpanded = this.getAttribute("expanded")
			
			this.shadowRoot.innerHTML = `
				<style>
					:host {
						display: block;
					}
					
					.expandable-item {
						border: 1px solid var(--secondary-hi);
						border-radius: 4px;
						margin-bottom: 1rem;
						overflow: hidden;
					}
					
					.expandable-header {
						display: flex;
						justify-content: space-between;
						align-items: center;
						padding: 1rem;
						background-color: var(--secondary-bg);
						cursor: pointer;
					}
					
					.expandable-content-preview {
						flex: 1;
					}
					
					.expandable-name {
						margin: 0 0 0.5rem 0;
						font-size: 1.1rem;
						color: var(--secondary-fg);
						text-transform: capitalize;
					}
					
					.expandable-summary {
						margin: 0;
						color: var(--secondary-fg);
						font-size: 0.95rem;
					}
					
					.expandable-arrow {
						display: inline-block;
						margin-left: 1rem;
						transition: transform 0.3s ease;
						font-size: 0.8rem;
						color: var(--secondary-hi);
					}
					
					.expandable-arrow.expanded {
						transform: rotate(90deg);
					}
					
					.expandable-body {
						padding: 1rem;
						color: var(--tertiary-fg);
						background-color: var(--tertiary-bg);
						border-top: 1px solid var(--tertiary-hi);
						display: none;
					}

					.expandable-body.expanded {
						display: block;
					}
				</style>
				
				<div class="expandable-item" part="base">
					<div class="expandable-header" part="header">
						<div class="expandable-content-preview" part="preview">
							<h4 class="expandable-name" part="name">${name}</h4>
							<p class="expandable-summary" part="summary">${summary}</p>
						</div>
						<span class="expandable-arrow" part="arrow">▶</span>
					</div>
					<div class="expandable-body" part="body">
						<slot></slot>
					</div>
				</div>
			`
			
			const header = this.shadowRoot.querySelector(".expandable-header")
			const body = this.shadowRoot.querySelector(".expandable-body")
			const arrow = this.shadowRoot.querySelector(".expandable-arrow")
			
			const clicker = () => {
				body.classList.toggle("expanded")
				arrow.classList.toggle("expanded")
			}
			header.addEventListener("click", clicker)
		if(initiallyExpanded) {
			clicker()
		}
		}
	}

	customElements.define("expandable-item", ExpandableItem)
})
</script>
