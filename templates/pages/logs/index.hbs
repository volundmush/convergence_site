<!-- {"title": "Convergence MUSH Logs", "slug": "logs"} -->

<h2>Convergence MUSH logs</h2>
<div class="pagination-controls">
	<button id="prevBtn">← Previous</button>
	<span id="pageInfo">Page 1</span>
	<button id="nextBtn">Next →</button>
	<button id="sortBtn">Sort: Descending</button>
</div>
<div class="logslist">
	<div class="logs-grid-header">
		<div class="logs-grid-cell">Scene ID</div>
		<div class="logs-grid-cell">Title</div>
		<div class="logs-grid-cell">Status</div>
		<div class="logs-grid-cell">Players</div>
	</div>
	<div id="logsTableBody" class="logs-grid"></div>
</div>

<script>
let currentStart = 0
let currentDesc = true

function loadPage(start = 0, desc = true) {
	currentStart = start
	currentDesc = desc
	
	const res = fetch("/api/logs/list/", {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({ start, desc })
	})
	.then(r => r.json())
	.then(scenes => {
		const tbody = document.querySelector("#logsTableBody")
		tbody.innerHTML = ""

		for(const scene of scenes) {
			const sceneNumber = scene.scene_id
			const title = scene.scene_title
			const status = scene.scene_status
			const players = []

			for(const player of scene.actors) {
				players.push({
					name: player.entity_name,
					objid: player.entity_objid
				})
			}

			const playerList = players.map(p => `${p.name} (${p.objid})`).join(", ")
			
			const row = document.createElement("div")
			row.className = "logs-grid-row"
			row.innerHTML = `
				<div class="logs-grid-cell">${sceneNumber}</div>
				<div class="logs-grid-cell">${title}</div>
				<div class="logs-grid-cell">${status}</div>
				<div class="logs-grid-cell">${playerList}</div>
			`
			tbody.appendChild(row)
		}
		
		updatePaginationControls()
	})
}

function previousPage() {
	const newStart = Math.max(0, currentStart - 50)
	loadPage(newStart, currentDesc)
}

function nextPage() {
	const newStart = currentStart + 50
	loadPage(newStart, currentDesc)
}

function toggleSort() {
	currentDesc = !currentDesc
	document.querySelector("#sortBtn").textContent = `Sort: ${currentDesc ? "Descending" : "Ascending"}`
	loadPage(0, currentDesc)
}

function updatePaginationControls() {
	document.querySelector("#pageInfo").textContent = `Page: ${Math.floor(currentStart / 50) + 1}`
	document.querySelector("#prevBtn").disabled = currentStart === 0
}

document.addEventListener("DOMContentLoaded", async () => {
	document.querySelector("#prevBtn").addEventListener("click", previousPage)
	document.querySelector("#nextBtn").addEventListener("click", nextPage)
	document.querySelector("#sortBtn").addEventListener("click", toggleSort)
	
	loadPage(0, true)
})
</script>


