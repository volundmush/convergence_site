<!-- {"title": "Convergence MUSH Logs", "slug": "logs"} -->

<h2>Convergence MUSH logs</h2>
<div class="pagination-controls" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0;">
	<button id="prevBtn" style="padding: 10px 20px; background: var(--secondary-bg); color: var(--secondary-fg); border: none; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.1s ease;">←<span class="button-text"> Previous</span></button>
	<span id="pageInfo" style="min-width: 120px; text-align: center; font-weight: bold;">Page 1</span>
	<button id="nextBtn" style="padding: 10px 20px; background: var(--secondary-bg); color: var(--secondary-fg); border: none; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.1s ease;"><span class="button-text">Next </span>→</button>
</div>
<div class="logslist-wrapper">
	<div class="logslist" id="logslist">
		<div class="logs-grid-header">
			<div class="logs-grid-cell">ID</div>
			<div class="logs-grid-cell">Title</div>
			<div class="logs-grid-cell">Status</div>
			<div class="logs-grid-cell">Players</div>
		</div>
		<div id="logsTableBody" class="logs-grid"></div>
	</div>
	<div class="logslist-fade logslist-fade-left"></div>
	<div class="logslist-fade logslist-fade-right"></div>
</div>


<script>
let currentStart = 0
let currentDesc = true
let totalPageCount = 0

async function loadPageCount() {
	try {
		const res = await fetch("/api/logs/pagecount/", {
			method: "POST",
			headers: { "Content-Type": "application/json" }
		})
		const data = await res.json()
		totalPageCount = data.pageCount
		updatePaginationControls()
	} catch (error) {
		console.error("Failed to load page count:", error)
	}
}

function loadPage(start = 0, desc = true) {
	currentStart = start
	currentDesc = desc
	const currentPage = Math.floor(start / 50) + 1
	window.location.hash = `page=${currentPage}`
	
	const res = fetch("/api/logs/list/", {
		method: "POST",
		headers: { "Content-Type": "application/json" },
		body: JSON.stringify({ start, desc })
	})
	.then(r => r.json())
	.then(scenes => {
		const tbody = document.querySelector("#logsTableBody")
		tbody.innerHTML = ""

		for(const scene of scenes) {
			const sceneNumber = scene.scene_id
			const title = scene.scene_title
			const status = scene.scene_status
			const players = []

			for(const player of scene.actors) {
				players.push({
					name: player.entity_name,
					entity_id: player.entity_id,
					entity_objid: player.entity_objid
				})
			}

			const playerList = players.map(p => {
				let dbref = p.entity_id // Use entity_id as fallback
				if (p.entity_objid) {
					dbref = p.entity_objid.split(':')[0].substring(1) // Remove # and extract dbref if objid exists
				}
				return `<a href="/characters/${dbref}/">${p.name}</a>`
			}).join(", ")
			
			const idCell = document.createElement("div")
			idCell.className = "logs-grid-cell"
			idCell.innerHTML = `<a href="/logs/${sceneNumber}/">${sceneNumber}</a>`
			tbody.appendChild(idCell)
			
			const titleCell = document.createElement("div")
			titleCell.className = "logs-grid-cell"
			titleCell.innerHTML = `<a href="/logs/${sceneNumber}/">${title}</a>`
			tbody.appendChild(titleCell)
			
			const statusCell = document.createElement("div")
			statusCell.className = "logs-grid-cell"
			statusCell.textContent = status
			tbody.appendChild(statusCell)
			
			const playersCell = document.createElement("div")
			playersCell.className = "logs-grid-cell"
			playersCell.innerHTML = playerList
			tbody.appendChild(playersCell)
		}
		
		updatePaginationControls()
	})
}

function previousPage() {
	const newStart = Math.max(0, currentStart - 50)
	loadPage(newStart, currentDesc)
}

function nextPage() {
	const currentPage = Math.floor(currentStart / 50) + 1
	if (currentPage < totalPageCount) {
		const newStart = currentStart + 50
		loadPage(newStart, currentDesc)
	}
}


function updatePaginationControls() {
	const currentPage = Math.floor(currentStart / 50) + 1
	document.querySelector("#pageInfo").textContent = `Page: ${currentPage} of ${totalPageCount}`
	document.querySelector("#prevBtn").disabled = currentStart === 0
	document.querySelector("#nextBtn").disabled = currentPage >= totalPageCount
}

document.addEventListener("DOMContentLoaded", async () => {
	document.querySelector("#prevBtn").addEventListener("click", previousPage)
	document.querySelector("#nextBtn").addEventListener("click", nextPage)
	
	await loadPageCount()
	
	// Check for page in URL hash
	const hash = window.location.hash.substring(1)
	const params = new URLSearchParams(hash)
	const pageFromHash = parseInt(params.get("page")) || 1
	const startFromHash = (pageFromHash - 1) * 50
	
	loadPage(startFromHash, true)
	
	// Handle hash changes (back/forward buttons)
	window.addEventListener("hashchange", () => {
		const newHash = window.location.hash.substring(1)
		const newParams = new URLSearchParams(newHash)
		const newPage = parseInt(newParams.get("page")) || 1
		const newStart = (newPage - 1) * 50
		if (newStart !== currentStart) {
			loadPage(newStart, currentDesc)
		}
	})
	
	// Update scroll fade on scroll and after content loads
	const logslist = document.getElementById("logslist")
	const logslistWrapper = logslist?.parentElement
	if (logslist && logslistWrapper) {
		const updateScrollFade = () => {
			const isScrolledLeft = logslist.scrollLeft > 0
			const isScrolledRight = logslist.scrollLeft < (logslist.scrollWidth - logslist.clientWidth - 5)
			
			logslistWrapper.classList.toggle("scrollable-left", isScrolledLeft)
			logslistWrapper.classList.toggle("scrollable-right", isScrolledRight)
		}
		logslist.addEventListener("scroll", updateScrollFade)
		setTimeout(updateScrollFade, 100)
	}
})
</script>


