<!-- {"title": "Convergence Mush Characters", "slug": "characters"} -->

<h2>Convergence MUSH characters</h3>
<div class="characterlists">
	<div>
		<h3>Player Characters</h3>
		<ul id="approved">
		</ul>
	</div>

	<div>
		<h3>Staff</h3>
		<ul id="staff">
		</ul>
	</div>
</div>
<div class="editpage">
	<h3>Edit your own page</h3>
	<form id="characterForm">
		<div>
			<label for="accountName">Account Name:</label>
			<input type="text" id="accountName" name="accountName" required />
		</div>
		<div>
			<label for="password">Password:</label>
			<input type="password" id="password" name="password" required />
		</div>
		<div>
			<label for="characterName">Character Name:</label>
			<input type="text" id="characterName" name="characterName" required />
		</div>
		<div>
			<label for="css">CSS:</label>
			<textarea id="css" name="css"></textarea>
		</div>
		<div>
			<label for="portrait">Portrait:</label>
			<input type="text" id="portrait" name="portrait" />
		</div>
		<div>
			<label for="gallery">Gallery:</label>
			<textarea id="gallery" name="gallery"></textarea>
		</div>
		<div>
			<label for="banner">Banner:</label>
			<textarea id="banner" name="banner"></textarea>
		</div>
		<button type="button" id="fetchBtn">Fetch</button>
	</form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
	const res = await fetch("/api/characters/get/")
	const characters = (await res.json()).sort((x, y) => x.name.localeCompare(y.name))
	const approved = document.querySelector("#approved")
	const staff = document.querySelector("#staff")
	for(character of characters) {
		if(!character.pc) {
			continue
		}

		const item = document.createElement("li")
		const path = character.dbref.replace('#', '')
		item.innerHTML = `<a href="/characters/${path}/">${character.name}</a>`

		if(character.bittype > 1) {
			staff.appendChild(item)
		} else if(character.approved) {
			approved.appendChild(item)
		}
	}

	// Wire up the character edit form
	const characterForm = document.querySelector("#characterForm")
	const fetchBtn = document.querySelector("#fetchBtn")

	fetchBtn.addEventListener("click", async (e) => {
		e.preventDefault()

		const payload = {
			accountName: document.querySelector("#accountName").value,
			password: document.querySelector("#password").value,
			characterName: document.querySelector("#characterName").value,
			css: document.querySelector("#css").value,
			portrait: document.querySelector("#portrait").value,
			gallery: document.querySelector("#gallery").value,
			banner: document.querySelector("#banner").value
		}

		try {
			const response = await fetch("/api/characters/edit/", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(payload)
			})

			const result = await response.json()

			if (response.ok) {
				alert("Character updated successfully!")
				characterForm.reset()
			} else {
				alert(`Error: ${result.error || "Failed to update character"}`)
			}
		} catch (error) {
			console.error("Error submitting form:", error)
			alert("An error occurred while updating the character")
		}
	})
})
</script>
