<!-- {"title": "Convergence Mush Characters", "slug": "characters"} -->

<h2>Convergence MUSH characters</h3>
<div class="characterlists">
</div>
<div class="editpage">
	<h3>Edit your own page</h3>
	<form id="characterForm">
		<div>
			<label for="accountName">Account Name:</label>
			<input type="text" id="accountName" name="accountName" required />
		</div>
		<div>
			<label for="password">Password:</label>
			<input type="password" id="password" name="password" required />
		</div>
		<div>
			<label for="characterName">Character Name:</label>
			<input type="text" id="characterName" name="characterName" required />
		</div>
		<div>
			<label for="css">CSS:</label>
			<textarea id="css" name="css"></textarea>
		</div>
		<div>
			<label for="portrait">Portrait:</label>
			<input type="text" id="portrait" name="portrait" />
		</div>
		<div>
			<label for="gallery">Gallery:</label>
			<textarea id="gallery" name="gallery"></textarea>
		</div>
		<div>
			<label for="banner">Banner:</label>
			<textarea id="banner" name="banner"></textarea>
		</div>
		<button type="button" id="fetchBtn">Save</button>
	</form>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
	const res = await fetch("/api/characters/get/")
	const characters = (await res.json()).sort((x, y) => x.name.localeCompare(y.name))
	const characterlists = document.querySelector(".characterlists")
	
	// Get all approved and staff characters
	const approvedChars = characters.filter(c => c.pc && c.approved && c.bittype <= 1)
	const staffChars = characters.filter(c => c.pc && c.bittype > 1)
	
	// Add Player Characters header
	if(approvedChars.length > 0) {
		const playerHeader = document.createElement("h3")
		playerHeader.textContent = "Player Characters"
		playerHeader.style.gridColumn = "1 / -1"
		characterlists.appendChild(playerHeader)
	}
	
	// Group approved characters by first letter
	let currentLetter = null
	let currentSection = null
	let currentUL = null
	
	for(character of approvedChars) {
		const firstLetter = character.name.charAt(0).toUpperCase()
		
		// Create new section if letter changes
		if(firstLetter !== currentLetter) {
			currentLetter = firstLetter
			currentSection = document.createElement("div")
			currentSection.className = "letter-section"
			const header = document.createElement("h4")
			header.textContent = currentLetter
			currentSection.appendChild(header)
			currentUL = document.createElement("ul")
			currentSection.appendChild(currentUL)
			characterlists.appendChild(currentSection)
		}
		
		const item = document.createElement("li")
		const path = character.dbref.replace('#', '')
		item.innerHTML = `<a href="/characters/${path}/">${character.name}</a>`
		currentUL.appendChild(item)
	}
	
	// Add Staff header
	if(staffChars.length > 0) {
		const staffHeader = document.createElement("h3")
		staffHeader.textContent = "Staff"
		staffHeader.style.gridColumn = "1 / -1"
		characterlists.appendChild(staffHeader)
	}
	
	// Group staff characters by first letter
	currentLetter = null
	currentSection = null
	currentUL = null
	
	for(character of staffChars) {
		const firstLetter = character.name.charAt(0).toUpperCase()
		
		// Create new section if letter changes
		if(firstLetter !== currentLetter) {
			currentLetter = firstLetter
			currentSection = document.createElement("div")
			currentSection.className = "letter-section"
			const header = document.createElement("h4")
			header.textContent = currentLetter
			currentSection.appendChild(header)
			currentUL = document.createElement("ul")
			currentSection.appendChild(currentUL)
			characterlists.appendChild(currentSection)
		}
		
		const item = document.createElement("li")
		const path = character.dbref.replace('#', '')
		item.innerHTML = `<a href="/characters/${path}/">${character.name}</a>`
		currentUL.appendChild(item)
	}

	// Wire up the character edit form
	const characterForm = document.querySelector("#characterForm")
	const fetchBtn = document.querySelector("#fetchBtn")

	fetchBtn.addEventListener("click", async (e) => {
		e.preventDefault()

		const payload = {
			accountName: document.querySelector("#accountName").value,
			password: document.querySelector("#password").value,
			characterName: document.querySelector("#characterName").value,
			css: document.querySelector("#css").value,
			portrait: document.querySelector("#portrait").value,
			gallery: document.querySelector("#gallery").value,
			banner: document.querySelector("#banner").value
		}

		try {
			const response = await fetch("/api/characters/edit/", {
				method: "POST",
				headers: {
					"Content-Type": "application/json"
				},
				body: JSON.stringify(payload)
			})

			const result = await response.json()

			if (response.ok) {
				alert("Character updated successfully!")
			} else {
				alert(`Error: ${result.error || "Failed to update character"}`)
			}
		} catch (error) {
			console.error("Error submitting form:", error)
			alert("An error occurred while updating the character")
		}
	})
})
</script>

