<!-- {"title": "Convergence Mush Character Page", "slug": "characters/:key"} -->

<div class="character">
	<div class="banner">
		<h2 class="name"></h2>
	</div>
	<div class="body">
		<div class="profile">
			<div class="staff">
				STAFF
			</div>
			<table class="finger">
			</table>
		</div>
		<div class="data">
			<div class="sheet">
			</div>
			<div class="gallery">
				<h3>Gallery</h3>
				<div class="contents">
				</div>
			</div>
			<div class="logs">
				<h3>Logs</h3>
			</div>
		</div>
	</div>
</div>

<script>
document.addEventListener("DOMContentLoaded", async () => {
	window.ansi = (await import("/static/ansi.js")).default
	window.optionalANSI = function(str) {
		str = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

		if(str.includes("\u001b")) {
			return window.ansi.html(str)
		} else {
			return str
		}
	}

	const res = await fetch(`/api/characters/get/${encodeURIComponent("{{ dbref }}")}`)
	const character = await res.json()
	window.character = character

	const oldTitle = document.querySelector("title").innerText
	document.querySelector("title").innerText = `${character.name} — ${oldTitle}`

	document.querySelector(".character .banner .name").innerHTML = optionalANSI(character.cname)

	if(character.bittype != "1") {
		document.querySelector(".character .body .profile").classList.add("staff")
	}

	character.finger.sex = character.sex
	character.finger.theme = character.theme
	character.finger.factions = character.factions.map(fac => fac.name).join(", ")

	const specialProfiles = ["PROFILE", "SKILLS"]

	for(key of Object.keys(character.finger).sort((a, b) => a.localeCompare(b, "en", {'sensitivity': "base"}))) {
		if(specialProfiles.includes(key)) {
			continue
		}
		const value = character.finger[key]
		const entry = document.createElement("tr")
		const entryKey = document.createElement("td")
		entryKey.classList.add("key")
		entryKey.innerText = key
		const entryValue = document.createElement("td")
		entryValue.innerHTML = optionalANSI(value)
		entryValue.classList.add("value")
		entry.appendChild(entryKey)
		entry.appendChild(entryValue)
		document.querySelector(".character .body .profile .finger").appendChild(entry)
	}

	const sheetsection = document.querySelector(".sheet")

	for(key of specialProfiles) {
		const value = character.finger[key]
		if(!value) {
			continue
		}

		const profilesection = document.createElement("expandable-item")
		profilesection.setAttribute("name", key.toLowerCase())
		profilesection.setAttribute("summary", "")
		profilesection.setAttribute("expanded", "true")

		const profilebody = document.createElement("p")
		profilebody.innerHTML = optionalANSI(value)
		profilesection.appendChild(profilebody)

		sheetsection.appendChild(profilesection)
	}

	const categories = [
		"Theme",
		"Faction",
		"Abilities",
		"Copied Powers",
		"Resources",
		"NPCs",
		"Extra Data",
		"Complications",
		"Info Files"
	]

	for(cat of categories) {
		const items = character.data[cat]
		if(!items || !items.length) continue

		const catsection = document.createElement("expandable-item")
		catsection.setAttribute("name", cat)
		catsection.setAttribute("summary", "")

		for(item of items) {
			if(cat == "Info Files" &&
			   ["portrait", "banner", "gallery", "css"].includes(item.name.toLowerCase())) {
				continue
			}

			const itemsection = document.createElement("expandable-item")
			const display = (() => {
				if(item.value) {
					return `${item.name} (${item.value})`
				} else {
					return item.name
				}
			})()
			itemsection.setAttribute("name", display)
			itemsection.setAttribute("summary", optionalANSI(item.summary))
			for(const para of item.body.split(/\n+/)) {
				const itembody = document.createElement("p")
				itembody.innerHTML = optionalANSI(para)
				itemsection.appendChild(itembody)
			}
			catsection.appendChild(itemsection)
		}
		sheetsection.appendChild(catsection)
	}

	if(character.data["Info Files"]) {
		const portrait = character.data["Info Files"].find((inf) => inf.name.toLowerCase() == "portrait")
		const banner = character.data["Info Files"].find((inf) => inf.name.toLowerCase() == "banner")
		const gallery = character.data["Info Files"].find((inf) => inf.name.toLowerCase() == "gallery")
		const css = character.data["Info Files"].find((inf) => inf.name.toLowerCase() == "css")

		if(portrait) {
			const img = document.createElement("img")
			img.setAttribute("src", portrait.body)
			document.querySelector(".profile :nth-child(1)").insertAdjacentElement("afterend", img)
		}

		if(banner) {
			const bannerElement = document.querySelector(".banner")
			if(bannerElement) {
				bannerElement.style.backgroundImage = `url('${banner.body}')`
				bannerElement.style.backgroundSize = "cover"
				bannerElement.style.backgroundPosition = "center"
			}
		}

		if(gallery) {
			for(url of gallery.body.split(/\s+/)) {
				const a = document.createElement("a")
				a.setAttribute("href", url)
				const img = document.createElement("img")
				img.setAttribute("src", url)

				a.appendChild(img)
				document.querySelector(".gallery .contents").insertAdjacentElement("beforeend", a)
			}
		}

		if(css) {
			const stylesheet = document.createElement("style")
			stylesheet.innerText = css.body.replace(/(\r|\n)/g, " ")
			document.body.appendChild(stylesheet)
		}
	}

	// Load character logs
	const objid = character.objid
	const logsRes = await fetch(`/api/logs/player/${encodeURIComponent(objid)}`)
	const logs = await logsRes.json()

	const logsContainer = document.querySelector(".character .data .logs")
	const logsExpandable = document.createElement("expandable-item")
	logsExpandable.setAttribute("name", "logs")
	logsExpandable.setAttribute("summary", logs && logs.length > 0 ? `${logs.length} logged scenes` : "No logs recorded")
	logsExpandable.setAttribute("expanded", "false")
	
	if(logs && logs.length > 0) {
		const logsGrid = document.createElement("div")
		logsGrid.classList.add("logs-grid")
		
		const header = document.createElement("div")
		header.classList.add("logs-grid-header")
		header.innerHTML = `
			<div class="logs-grid-cell">ID</div>
			<div class="logs-grid-cell">Title</div>
			<div class="logs-grid-cell">Date</div>
		`
		logsExpandable.appendChild(header)
		
		for(const log of logs) {
			const idCell = document.createElement("div")
			idCell.classList.add("logs-grid-cell")
			idCell.innerHTML = `<a href="/logs/${log.scene_id}/">${log.scene_id}</a>`
			logsGrid.appendChild(idCell)
			
			const titleCell = document.createElement("div")
			titleCell.classList.add("logs-grid-cell")
			titleCell.innerHTML = `<a href="/logs/${log.scene_id}/">${log.scene_title}</a>`
			logsGrid.appendChild(titleCell)
			
			const dateCell = document.createElement("div")
			dateCell.classList.add("logs-grid-cell")
			if(log.scene_date) {
				const dateObj = new Date(log.scene_date)
				dateCell.textContent = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
			} else {
				dateCell.textContent = "-"
			}
			logsGrid.appendChild(dateCell)
		}
		logsGrid.classList.add("expandable-content")
		logsExpandable.appendChild(logsGrid)
	}
	
	logsContainer.appendChild(logsExpandable)
})

// Expandable web component

// <expandable-item name="Component Name" summary="Summary text goes here">
	// <p>Full content appears here when expanded.</p>
// </expandable-item>

class ExpandableItem extends HTMLElement {
	constructor() {
		super()
		this.attachShadow({ mode: "open" })
	}

	connectedCallback() {
		const name = this.getAttribute("name") || "Item"
		const summary = this.getAttribute("summary") || ""
		const initiallyExpanded = this.getAttribute("expanded")
		
		this.shadowRoot.innerHTML = `
			<style>
				:host {
					display: block;
				}
				
				.expandable-item {
					border: 1px solid var(--secondary-hi);
					border-radius: 4px;
					margin-bottom: 1rem;
					overflow: hidden;
				}
				
				.expandable-header {
					display: flex;
					justify-content: space-between;
					align-items: center;
					padding: 1rem;
					background-color: var(--secondary-bg);
					cursor: pointer;
				}
				
				.expandable-content-preview {
					flex: 1;
				}
				
				.expandable-name {
					margin: 0 0 0.5rem 0;
					font-size: 1.1rem;
					color: var(--secondary-fg);
					text-transform: capitalize;
				}
				
				.expandable-summary {
					margin: 0;
					color: var(--secondary-fg);
					font-size: 0.95rem;
				}
				
				.expandable-arrow {
					display: inline-block;
					margin-left: 1rem;
					transition: transform 0.3s ease;
					font-size: 0.8rem;
					color: var(--secondary-hi);
				}
				
				.expandable-arrow.expanded {
					transform: rotate(90deg);
				}
				
				.expandable-body {
					padding: 1rem;
					color: var(--tertiary-fg);
					background-color: var(--tertiary-bg);
					border-top: 1px solid var(--tertiary-hi);
					display: none;
				}

				.expandable-body.expanded {
					display: block;
				}
			</style>
			
			<div class="expandable-item" part="base">
				<div class="expandable-header" part="header">
					<div class="expandable-content-preview" part="preview">
						<h4 class="expandable-name" part="name">${name}</h4>
						<p class="expandable-summary" part="summary">${summary}</p>
					</div>
					<span class="expandable-arrow" part="arrow">▶</span>
				</div>
				<div class="expandable-body" part="body">
					<slot></slot>
				</div>
			</div>
		`
		
		const header = this.shadowRoot.querySelector(".expandable-header")
		const body = this.shadowRoot.querySelector(".expandable-body")
		const arrow = this.shadowRoot.querySelector(".expandable-arrow")
		
		const clicker = () => {
			body.classList.toggle("expanded")
			arrow.classList.toggle("expanded")
		}
		header.addEventListener("click", clicker)
		if(initiallyExpanded) {
			clicker()
		}
	}
}

customElements.define("expandable-item", ExpandableItem)
</script>
